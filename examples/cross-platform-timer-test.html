<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¨å¹³å°ç²¾å‡†å®šæ—¶å™¨æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .timing-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
        }
        .accuracy-good { color: #28a745; }
        .accuracy-warning { color: #ffc107; }
        .accuracy-error { color: #dc3545; }
        .environment-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è·¨å¹³å°ç²¾å‡†å®šæ—¶å™¨æµ‹è¯•</h1>
        
        <div class="environment-info">
            <h3>ğŸŒ ç¯å¢ƒä¿¡æ¯</h3>
            <div id="envInfo">æ£€æµ‹ä¸­...</div>
        </div>
        
        <div class="controls">
            <button id="startBtn">å¼€å§‹æµ‹è¯• (120 BPM)</button>
            <button id="stopBtn" disabled>åœæ­¢æµ‹è¯•</button>
            <button id="clearBtn">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div class="stats">
            <div class="stat-box">
                <div id="beatCount" class="stat-value">0</div>
                <div class="stat-label">èŠ‚æ‹æ€»æ•°</div>
            </div>
            <div class="stat-box">
                <div id="avgAccuracy" class="stat-value">0ms</div>
                <div class="stat-label">å¹³å‡è¯¯å·®</div>
            </div>
            <div class="stat-box">
                <div id="maxError" class="stat-value">0ms</div>
                <div class="stat-label">æœ€å¤§è¯¯å·®</div>
            </div>
        </div>
        
        <div id="timingLog" class="timing-log"></div>
    </div>

    <script src="../dist/js-beat-emitter.browser.js"></script>
    <script>
        let beatEmitter = null;
        let timingData = [];
        let expectedInterval = 500; // 120 BPM = 500ms interval
        let startTime = 0;

        // DOM å…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const beatCount = document.getElementById('beatCount');
        const avgAccuracy = document.getElementById('avgAccuracy');
        const maxError = document.getElementById('maxError');
        const timingLog = document.getElementById('timingLog');
        const envInfo = document.getElementById('envInfo');

        // é«˜ç²¾åº¦æ—¶é—´å‡½æ•°
        function getHighResTime() {
            if (typeof performance !== 'undefined' && performance.now) {
                return performance.now();
            }
            return Date.now();
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function showEnvironmentInfo() {
            const info = [];
            
            // æµè§ˆå™¨ä¿¡æ¯
            info.push(`æµè§ˆå™¨: ${navigator.userAgent.split(' ')[0]}`);
            
            // æ—¶é—´ç²¾åº¦
            if (typeof performance !== 'undefined' && performance.now) {
                info.push('â±ï¸ æ—¶é—´ç²¾åº¦: performance.now() (äºšæ¯«ç§’çº§)');
            } else {
                info.push('â±ï¸ æ—¶é—´ç²¾åº¦: Date.now() (æ¯«ç§’çº§)');
            }
            
            // requestAnimationFrame æ”¯æŒ
            if (typeof requestAnimationFrame !== 'undefined') {
                info.push('ğŸ¬ åŠ¨ç”»å¸§: æ”¯æŒ requestAnimationFrame');
            } else {
                info.push('ğŸ¬ åŠ¨ç”»å¸§: ä¸æ”¯æŒ requestAnimationFrame');
            }
            
            // setTimeout ç²¾åº¦æµ‹è¯•
            const testStart = getHighResTime();
            setTimeout(() => {
                const testEnd = getHighResTime();
                const actualDelay = testEnd - testStart;
                info.push(`â° setTimeout(1ms) å®é™…å»¶è¿Ÿ: ${actualDelay.toFixed(2)}ms`);
                envInfo.innerHTML = info.join('<br>');
            }, 1);
            
            envInfo.innerHTML = info.slice(0, -1).join('<br>') + '<br>â° æµ‹è¯• setTimeout ç²¾åº¦ä¸­...';
        }

        // å¼€å§‹æµ‹è¯•
        startBtn.addEventListener('click', () => {
            timingData = [];
            
            beatEmitter = new BeatEmitter({
                mode: 'timer-based',
                bpm: 120,
                beatsPerMeasure: 4
            });
            
            startTime = getHighResTime();
            
            beatEmitter.on('beat', handleBeat);
            beatEmitter.on('started', () => {
                addLog('âœ… ç²¾å‡†å®šæ—¶å™¨å·²å¯åŠ¨', 'info');
                startBtn.disabled = true;
                stopBtn.disabled = false;
            });
            
            beatEmitter.on('stopped', () => {
                addLog('â¹ï¸ å®šæ—¶å™¨å·²åœæ­¢', 'info');
                startBtn.disabled = false;
                stopBtn.disabled = true;
                showFinalStats();
            });
            
            beatEmitter.start();
        });

        // åœæ­¢æµ‹è¯•
        stopBtn.addEventListener('click', () => {
            if (beatEmitter) {
                beatEmitter.stop();
            }
        });

        // æ¸…é™¤æ—¥å¿—
        clearBtn.addEventListener('click', () => {
            timingLog.innerHTML = '';
            timingData = [];
            updateStats();
        });

        function handleBeat(beatData) {
            const currentTime = getHighResTime();
            const expectedTime = startTime + (timingData.length * expectedInterval);
            const actualTime = currentTime;
            const error = actualTime - expectedTime;
            
            timingData.push({
                expected: expectedTime,
                actual: actualTime,
                error: error,
                beat: beatData.beat
            });
            
            // åˆ†ç±»è¯¯å·®
            let errorClass = 'accuracy-good';
            if (Math.abs(error) > 2) errorClass = 'accuracy-warning';
            if (Math.abs(error) > 5) errorClass = 'accuracy-error';
            
            const beatMarker = beatData.beat === 1 ? 'ğŸ”´' : 'âšª';
            addLog(
                `${beatMarker} èŠ‚æ‹ ${timingData.length} (${beatData.beat}/${beatData.totalBeats}) - è¯¯å·®: ${error.toFixed(2)}ms`,
                errorClass
            );
            
            updateStats();
        }

        function updateStats() {
            beatCount.textContent = timingData.length;
            
            if (timingData.length > 0) {
                const errors = timingData.map(d => Math.abs(d.error));
                const avgError = errors.reduce((sum, e) => sum + e, 0) / errors.length;
                const maxErr = Math.max(...errors);
                
                avgAccuracy.textContent = `${avgError.toFixed(2)}ms`;
                maxError.textContent = `${maxErr.toFixed(2)}ms`;
                
                // æ ¹æ®ç²¾åº¦ç€è‰²
                avgAccuracy.className = 'stat-value ' + (avgError < 2 ? 'accuracy-good' : avgError < 5 ? 'accuracy-warning' : 'accuracy-error');
                maxError.className = 'stat-value ' + (maxErr < 5 ? 'accuracy-good' : maxErr < 10 ? 'accuracy-warning' : 'accuracy-error');
            } else {
                avgAccuracy.textContent = '0ms';
                maxError.textContent = '0ms';
                avgAccuracy.className = 'stat-value';
                maxError.className = 'stat-value';
            }
        }

        function showFinalStats() {
            if (timingData.length < 2) return;
            
            const errors = timingData.map(d => Math.abs(d.error));
            const avgError = errors.reduce((sum, e) => sum + e, 0) / errors.length;
            const maxErr = Math.max(...errors);
            const minErr = Math.min(...errors);
            
            // è®¡ç®—æ ‡å‡†åå·®
            const variance = errors.reduce((sum, e) => sum + Math.pow(e - avgError, 2), 0) / errors.length;
            const stdDev = Math.sqrt(variance);
            
            // ç´¯ç§¯è¯¯å·®
            const lastBeat = timingData[timingData.length - 1];
            const totalDrift = lastBeat.error;
            
            addLog('ğŸ“Š === æœ€ç»ˆç»Ÿè®¡ ===', 'info');
            addLog(`ğŸ“ˆ å¹³å‡è¯¯å·®: ${avgError.toFixed(2)}ms`, avgError < 2 ? 'accuracy-good' : 'accuracy-warning');
            addLog(`ğŸ“ˆ æœ€å¤§è¯¯å·®: ${maxErr.toFixed(2)}ms`, 'info');
            addLog(`ğŸ“ˆ æœ€å°è¯¯å·®: ${minErr.toFixed(2)}ms`, 'info');
            addLog(`ğŸ“ˆ æ ‡å‡†åå·®: ${stdDev.toFixed(2)}ms`, 'info');
            addLog(`ğŸ“ˆ ç´¯ç§¯åç§»: ${totalDrift.toFixed(2)}ms`, Math.abs(totalDrift) < 50 ? 'accuracy-good' : 'accuracy-warning');
            
            // ç²¾åº¦è¯„ä»·
            if (avgError < 2) {
                addLog('ğŸ¯ ç²¾åº¦è¯„ä»·: ä¼˜ç§€', 'accuracy-good');
            } else if (avgError < 5) {
                addLog('ğŸ‘ ç²¾åº¦è¯„ä»·: è‰¯å¥½', 'accuracy-warning');
            } else {
                addLog('âš ï¸ ç²¾åº¦è¯„ä»·: ä¸€èˆ¬', 'accuracy-error');
            }
        }

        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${time}] ${message}`;
            timingLog.appendChild(entry);
            timingLog.scrollTop = timingLog.scrollHeight;
        }

        // åˆå§‹åŒ–
        updateStats();
        showEnvironmentInfo();
        addLog('ğŸ’¡ æ–°çš„è·¨å¹³å°ç²¾å‡†å®šæ—¶å™¨ - ä½¿ç”¨ setTimeout é€’å½’å®ç°', 'info');
        addLog('ğŸ¯ ä¼˜åŠ¿: æµè§ˆå™¨å’Œ Node.js ç¯å¢ƒé€šç”¨', 'info');
        addLog('âš¡ ç‰¹æ€§: åŠ¨æ€æ£€æŸ¥é—´éš”ï¼Œé«˜ç²¾åº¦æ—¶é—´æˆ³ï¼Œé¿å…ç´¯ç§¯è¯¯å·®', 'info');
    </script>
</body>
</html>
